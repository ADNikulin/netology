# 12.8. Реляционные базы данных и администрирование баз данных — Никулин Александр
# Домашнее задание к занятию «Базы данных в облаке»

### Цель задания

На лекции вы узнали, как работать с системами управления баз данных. Теперь вы поработаете над созданием кластера и проверке работоспособности репликации в кластере. В результате выполнения этого задания вы научитесь:
* создавать кластер PostgreSQL;
* подключаться к мастеру и реплике;
* проверять работоспособность репликации в кластере
---

Домашнее задание подразумевает, что вы уже делали предыдущие работы в Яндекс.Облаке, и у вас есть аккаунт и каталог.

Используйте следующие рекомендации во избежание лишних трат в Яндекс.Облаке:
1) Сразу после выполнения задания удалите кластер.
2) Если вы решили взять паузу на выполнение задания, то остановите кластер.

### Задание

#### Создание кластера
1. Перейдите на главную страницу сервиса Managed Service for PostgreSQL.
1. Создайте кластер PostgreSQL со следующими параметрами:
- класс хоста: s2.micro, диск network-ssd любого размера;
- хосты: нужно создать два хоста в двух разных зонах доступности и указать необходимость публичного доступа, то есть публичного IP адреса, для них;
- установите учётную запись для пользователя и базы.

Остальные параметры оставьте по умолчанию либо измените по своему усмотрению.

* Нажмите кнопку «Создать кластер» и дождитесь окончания процесса создания, статус кластера = RUNNING. Кластер создаётся от 5 до 10 минут.

![cluster-db](https://github.com/ADNikulin/netology/assets/44374132/f41c06e8-ccca-4da6-8e35-881e2d6de4b2)
![image](https://github.com/ADNikulin/netology/assets/44374132/36ec04b2-e2d6-4245-b3fb-e457dd8deb07)

#### Подключение к мастеру и реплике 

* Используйте инструкцию по подключению к кластеру, доступную на вкладке «Обзор»: cкачайте SSL-сертификат и подключитесь к кластеру с помощью утилиты psql, указав hostname всех узлов и атрибут ```target_session_attrs=read-write```.
![image](https://github.com/ADNikulin/netology/assets/44374132/43c8f810-67b6-4db1-8bac-c94a19aae547)
![image](https://github.com/ADNikulin/netology/assets/44374132/b9cc5564-e81a-4051-8122-b41558b43cde)

* Проверьте, что подключение прошло к master-узлу.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
![image](https://github.com/ADNikulin/netology/assets/44374132/2f9c1c50-ab40-4fd8-9d9f-3565d7361178)

* Посмотрите количество подключенных реплик:
```
select count(*) from pg_stat_replication;
```
![image](https://github.com/ADNikulin/netology/assets/44374132/a95ac491-a012-462a-ad6a-796c3e61a616)

### Проверьте работоспособность репликации в кластере

* Создайте таблицу и вставьте одну-две строки.
```
CREATE TABLE test_table(text varchar);
```
```
insert into test_table values('Строка 1');
```
![image](https://github.com/ADNikulin/netology/assets/44374132/f64b291a-f653-4902-86fa-668249fc9c96)

* Выйдите из psql командой ```\q```.

* Теперь подключитесь к узлу-реплике. Для этого из команды подключения удалите атрибут ```target_session_attrs```  и в параметре атрибут ```host``` передайте только имя хоста-реплики. Роли хостов можно посмотреть на соответствующей вкладке UI консоли.

* Проверьте, что подключение прошло к узлу-реплике.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
![image](https://github.com/ADNikulin/netology/assets/44374132/997e4403-b051-445c-a3ff-a095d008191a)

* Проверьте состояние репликации
```
select status from pg_stat_wal_receiver;
```
![image](https://github.com/ADNikulin/netology/assets/44374132/e574aa02-8004-4f09-9fca-ff3fa99ef571)

* Для проверки, что механизм репликации данных работает между зонами доступности облака, выполните запрос к таблице, созданной на предыдущем шаге:
```
select * from test_table;
```
![image](https://github.com/ADNikulin/netology/assets/44374132/649d84b4-3ce5-4864-b77d-a3a4892544ec)
